<!DOCTYPE html>
<html>
    <head>
        <!-- Latest compiled and minified CSS -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">

        <!-- jQuery library -->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

        <!-- Latest compiled JavaScript -->
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
        <script src="/static/utilities.js"></script>
        <title>Pagina di dettaglio alloggio</title>
        <nav class="navbar navbar-inverse navbar-static-top" role="navigation">
            <div class="container">
              <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                              <span class="sr-only">Toggle navigation</span>
                              <span class="icon-bar"></span>
                              <span class="icon-bar"></span>
                              <span class="icon-bar"></span>
                          </button>
              </div>
          
              <!-- Collect the nav links, forms, and other content for toggling -->
              <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav">
                  <li onclick="window.location.replace('https://scroccotour-frontend.herokuapp.com/profilo')"><a href="#">I tuoi Tour</a></li>
                          <li onclick="window.location.replace('https://scroccotour-frontend.herokuapp.com/profilo')"><a href="#">TopTour</a></li>
                          <li onclick="window.location.replace('https://scroccotour-frontend.herokuapp.com/profilo')"><a href="#">Nuovo Tour</a></li>
                          <li onclick="window.location.replace('https://scroccotour-frontend.herokuapp.com/profilo')"><a href="#">Profilo</a></li>
                          <li onclick="window.location.replace('https://scroccotour-frontend.herokuapp.com/profilo')"><a href="#">Recensioni</a></li>
                          <li onclick="window.location.replace('https://scroccotour-frontend.herokuapp.com/logout')"><a href="#">Logout</a></li>
                </ul>
              </div>
            </div>
          </nav>
    </head>
    <body>
        <div class="container">
            <h2>Informazioni per l'alloggio a <label id="meta"></label></h2>
            <label for="nights">Nights of the stay:</label>
            <select name="nights" id="nights">
            </select>
            <div id="checkbox">

            </div>
            <form>
                <input type="button" id="back" value="Go to previous page">
                <input type="button" id="submit" value="Submit">
            </form>
            <br>
            <br>
            <label id="noItems"></label>
            <table id="table">

            </table>
            
        </div>

        <script>
            var token = getCookie("jwt");
            var data = parseJwt(token);
            var startDateGlobal;
            var endDateGlobal;
            var items = document.getElementById('noItems');
            var submit = document.getElementById('submit');
            var back = document.getElementById('back');
            var checkbox = document.getElementById('checkbox');
            var meta = document.getElementById('meta');
            var table = document.getElementById("table");
            var tags = new Set();
            var box;
            var label;
            var button;
            var cityGlobal;
            var numberOfTags=0;
            var id = [];
            var stringTour;
            var selector;
            var tour;


            //Carico senza i tag tutti gli alloggi disponibili in quella data
            //aggiorno anche nome e tag in base agli alloggi trovati, creando gi√† i link per l'approfondimento
            //dell'alloggio
            window.onload = async function(){
                const queryString = window.location.search;
                const urlParams = new URLSearchParams(queryString);
                tour = JSON.parse(urlParams.get('tour'));
                var city = urlParams.get('city');
                cityGlobal=city;
                meta.innerText=city;


                var startDate = tour.start*1000;
                var nights = tour.nights_remaining;
                var endDate = startDate + (nights*24*60*60*1000);
                startDateGlobal = Number(startDate);
                endDateGlobal = Number(endDate);

                selector = document.getElementById("nights")
                for(let i=1; i<=nights; i++){
                    selector.options[selector.options.length] = new Option(i,i);
                }
                var response = await fetch('https://scroccotour-backend.herokuapp.com/api/v1/lista-hosting/alloggi', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'Authorization': 'Bearer ' + token
                        },
                        body: new URLSearchParams({
                            'start': startDateGlobal,
                            'end': endDateGlobal,
                            'city': city,
                         }),
                    });
                    const myJson = await response.json()
                    console.log(myJson);
                    if(myJson.length == 0){
                        items.innerText = "Non ci sono alloggi per questa meta nelle date inserite"
                    }
                    else{
                        myJson.forEach( d => {
                            for(let i=0; i<d.tags.length ;i++){
                                tags.add(d.tags[i])
                            }
                            })
                            tags.forEach(tag =>{
                            label = document.createElement('label')
                            label.htmlFor = tag;
                            label.appendChild(document.createTextNode(tag));
                            checkbox.appendChild(label)
                            box = document.createElement('input');
                            box.type = 'checkbox';
                            box.name = "tag" + numberOfTags;
                            box.value = tag;
                            box.id = "tag" + numberOfTags;
                            numberOfTags=numberOfTags+1;
                            checkbox.appendChild(box);
                            })  
                    }
                }
                
                //Al cliccare del bottone, aggiorno la pagina in base ai filtri
                submit.onclick = async function(){
                    const tagArray = []
                    for(let i=0; i< numberOfTags; i++){
                        if(document.getElementById('tag'+i).checked){
                            tagArray.push(document.getElementById('tag'+i).value)
                        }
                    }
                    var valore = selector.value;
                    endDateGlobal = startDateGlobal+ (valore*24*60*60*1000);
                    var response = await fetch('https://scroccotour-backend.herokuapp.com/api/v1/lista-hosting/alloggi', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'Authorization': 'Bearer ' + token
                        },
                        body:new URLSearchParams({
                            'start': startDateGlobal,
                            'end': endDateGlobal,
                            'city': cityGlobal,
                            'tag' : tagArray
                         }),
                    });
                    const myJson = await response.json();
                    console.log(myJson);
                    table.innerHTML = "";
                    checkbox.innerHTML = "";
                    numberOfTags = 0;
                    myJson.forEach( d => {

                        var row = table.insertRow(0);
                        row.onclick = window.location.replace("#")
                        var cell1 = row.insertCell(0);
                        cell1.innerHTML = '<a href="https://scroccotour-frontend.herokuapp.com/info-alloggio?tourId='+tour._id+'&cityId='+d._id+'&city='+cityGlobal+'&start='+startDateGlobal+'&end='+endDateGlobal+'&host='+d.host+'&address='+d.address+'">'+d.host+'</a>';
                        })
                        tags.forEach(tag =>{
                        label = document.createElement('label')
                        label.htmlFor = tag;
                        label.appendChild(document.createTextNode(tag));
                        checkbox.appendChild(label)
                        box = document.createElement('input');
                        box.type = 'checkbox';
                        box.name = "tag" + numberOfTags;
                        box.value = tag;
                        box.id = "tag" + numberOfTags;
                        numberOfTags=numberOfTags+1
                        checkbox.appendChild(box);
                        })  
                }

                back.onclick = function(){
                    window.location.replace("https://scroccotour-frontend.herokuapp.com/tour?tour=" + urlParams.get('tour'));
                }
        </script>
    </body>
</html>